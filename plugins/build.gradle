subprojects {
    jar {
        manifest {
            attributes 'Plugin-Class': "${pluginClass}",
                    'Plugin-Id': "${pluginId}",
                    'Plugin-Version': "${pluginversion}",
                    'Plugin-Provider': "${pluginProvider}"
        }
    }

    configurations {
        pluginDeps.extendsFrom implementation
    }

    task plugin(type: Jar) {
        archiveBaseName.set("${pluginId}")
        into('classes') {
            with jar
        }
        into('lib') {
            from configurations.pluginDeps
        }
        archiveExtension.set('zip')
    }

    task assemblePlugin(type: Copy) {
        from plugin
        into pluginsDir
    }
}

task assemblePlugins(type: Copy) {
    dependsOn subprojects.assemblePlugin
}

build.dependsOn project.tasks.assemblePlugins